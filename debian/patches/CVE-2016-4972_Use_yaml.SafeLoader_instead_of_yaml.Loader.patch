Description: Use yaml.SafeLoader instead of yaml.Loader
 Before this patch yaml.Loader was used by the client to create custom
 yaql-enabled yaml loader. It is unsfae do to so, because yaml.Loader is
 capable of creating custom python objects from specifically constructed
 yaml files.
 UI parsing functions also fell back to yaml.Loader if
 the custom loader was not supplied.
 After this patch all yaml load operations are performed with safe
 loaders instead.
Author: Kirill Zaitsev <kzaitsev@mirantis.com>
Origin: upstream, https://review.openstack.org/#/c/333440/
Change-Id: Id9bb6eabda35522271ec394f8758a974878cbb4b
Date: Thu, 26 May 2016 22:04:31 +0000 (+0300)
X-Git-Tag: 0.8.5~1
X-Git-Url: https://review.openstack.org/gitweb?p=openstack%2Fpython-muranoclient.git;a=commitdiff_plain;h=cd182ba363a11078ae7a0595f54751c1ebddd2e0
Bug-Ubuntu: https://launchpad.net/bugs/1586078
Bug-Debian: https://bugs.debian.org/cgi-bin/828063
Last-Update: 2016-06-27

Index: python-muranoclient/muranoclient/common/utils.py
===================================================================
--- python-muranoclient.orig/muranoclient/common/utils.py
+++ python-muranoclient/muranoclient/common/utils.py
@@ -605,12 +605,12 @@ class Bundle(FileWrapperMixin):
             yield pkg_obj
 
 
-class YaqlYamlLoader(yaml.Loader):
+class YaqlYamlLoader(yaml.SafeLoader):
     pass
 
 # workaround for PyYAML bug: http://pyyaml.org/ticket/221
 resolvers = {}
-for k, v in yaml.Loader.yaml_implicit_resolvers.items():
+for k, v in yaml.SafeLoader.yaml_implicit_resolvers.items():
     resolvers[k] = v[:]
 YaqlYamlLoader.yaml_implicit_resolvers = resolvers
 
Index: python-muranoclient/muranoclient/v1/artifact_packages.py
===================================================================
--- python-muranoclient.orig/muranoclient/v1/artifact_packages.py
+++ python-muranoclient/muranoclient/v1/artifact_packages.py
@@ -190,7 +190,7 @@ class ArtifactRepo(object):
         ui_stream = "".join(
             self.client.artifacts.download_blob(app_id, 'ui_definition'))
         if loader_cls is None:
-            loader_cls = yaml.Loader
+            loader_cls = yaml.SafeLoader
         return yaml.load(ui_stream, loader_cls)
 
     def get_logo(self, app_id):
Index: python-muranoclient/muranoclient/v1/package_creator/hot_package.py
===================================================================
--- python-muranoclient.orig/muranoclient/v1/package_creator/hot_package.py
+++ python-muranoclient/muranoclient/v1/package_creator/hot_package.py
@@ -43,7 +43,7 @@ def generate_manifest(args):
         args.full_name = '{0}.{1}'.format(prefix, normalized_name)
     try:
         with open(args.template, 'rb') as heat_file:
-            yaml_content = yaml.load(heat_file)
+            yaml_content = yaml.safe_load(heat_file)
             if not args.description:
                 args.description = yaml_content.get(
                     'description',
Index: python-muranoclient/muranoclient/v1/packages.py
===================================================================
--- python-muranoclient.orig/muranoclient/v1/packages.py
+++ python-muranoclient/muranoclient/v1/packages.py
@@ -147,7 +147,7 @@ class PackageManager(base.Manager):
 
     def get_ui(self, app_id, loader_cls=None):
         if loader_cls is None:
-            loader_cls = yaml.Loader
+            loader_cls = yaml.SafeLoader
 
         url = '/v1/catalog/packages/{0}/ui'.format(app_id)
         response = self.api.raw_request('GET', url)
Index: python-muranoclient/releasenotes/notes/safeloader-cve-2016-4972-e3f7ad9b234655ca.yaml
===================================================================
--- /dev/null
+++ python-muranoclient/releasenotes/notes/safeloader-cve-2016-4972-e3f7ad9b234655ca.yaml
@@ -0,0 +1,9 @@
+---
+security:
+  - cve-2016-4972 has been addressed. In ceveral places
+    Murano used loaders inherited directly from yaml.Loader
+    when parsing MuranoPL and UI files from packages.
+    This is unsafe, because this loader is capable of creating
+    custom python objects from specifically constructed
+    yaml files. With this change all yaml loading operations are done
+    using safe loaders instead.
